{
  "project": "Internal Link Finder SaaS",
  "branchName": "ralph/saas-transformation",
  "description": "Transform Internal Link Finder from a stateless tool into a production-ready SaaS platform with email/password auth, Free/Pro subscription tiers ($29/mo), Stripe billing, persistent sessions via Neon Postgres, backend AI (Gemini) proxy, and Brevo transactional email. Security-first: bcrypt passwords, JWT with httpOnly cookies, RLS on all tables, server-side plan enforcement.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add Python dependencies for auth, database, billing, and email",
      "description": "As a developer, I need all required Python packages installed so the SaaS backend can be built.",
      "acceptanceCriteria": [
        "Add to requirements.txt: passlib[bcrypt]>=1.7.4, python-jose[cryptography]>=3.3.0, asyncpg>=0.29.0, sqlalchemy[asyncio]>=2.0, alembic, stripe>=7.0.0, sib-api-v3-sdk, slowapi, python-multipart",
        "Add to requirements.txt: email-validator>=2.0.0",
        "requirements.txt remains valid (no conflicts with existing deps)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create database.py with async SQLAlchemy engine",
      "description": "As a developer, I need a database connection module so all backend routes can query Neon Postgres asynchronously.",
      "acceptanceCriteria": [
        "Create database.py at project root",
        "Reads DATABASE_URL from environment variable",
        "Creates async SQLAlchemy engine using asyncpg driver",
        "Exports async_session_factory (AsyncSession) for use as FastAPI dependency",
        "Exports Base (DeclarativeBase) for model definitions",
        "Exports get_db() async generator dependency for FastAPI",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create SQL migration with all 5 tables and RLS policies",
      "description": "As a developer, I need the full database schema created in Neon so user data can be persisted securely.",
      "acceptanceCriteria": [
        "Create migrations/001_initial.sql with CREATE TABLE for: users, subscriptions, analysis_sessions, saved_links, ai_usage",
        "users: id (UUID PK), email (TEXT UNIQUE NOT NULL), password_hash (TEXT NOT NULL), plan (TEXT DEFAULT 'free'), created_at (TIMESTAMPTZ DEFAULT now()), reset_token (TEXT), reset_token_expires (TIMESTAMPTZ)",
        "subscriptions: id (UUID PK), user_id (UUID FK users.id ON DELETE CASCADE), stripe_customer_id (TEXT), stripe_subscription_id (TEXT), status (TEXT), current_period_end (TIMESTAMPTZ), created_at (TIMESTAMPTZ DEFAULT now())",
        "analysis_sessions: id (UUID PK), user_id (UUID FK), domain (TEXT), config (JSONB), results (JSONB), created_at (TIMESTAMPTZ DEFAULT now()), updated_at (TIMESTAMPTZ DEFAULT now())",
        "saved_links: id (UUID PK), user_id (UUID FK), session_id (UUID FK analysis_sessions.id ON DELETE SET NULL), link_data (JSONB NOT NULL), created_at (TIMESTAMPTZ DEFAULT now())",
        "ai_usage: id (UUID PK), user_id (UUID FK UNIQUE), call_count (INT DEFAULT 0), period_start (TIMESTAMPTZ), period_end (TIMESTAMPTZ)",
        "Enable RLS on all 5 tables with: ALTER TABLE x ENABLE ROW LEVEL SECURITY",
        "Create RLS policies so users can only SELECT/INSERT/UPDATE/DELETE their own rows",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create SQLAlchemy ORM models for all 5 tables",
      "description": "As a developer, I need ORM models so backend routes can interact with the database using typed Python objects.",
      "acceptanceCriteria": [
        "Create db_models.py at project root (separate from existing models.py which has Pydantic models)",
        "Define User, Subscription, AnalysisSession, SavedLink, AiUsage as SQLAlchemy mapped classes using Base from database.py",
        "All fields match the SQL schema from US-003",
        "Relationships defined: User.subscriptions (one-to-many), User.sessions (one-to-many), User.saved_links (one-to-many)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create auth utilities: password hashing and JWT tokens",
      "description": "As a developer, I need utility functions for secure password handling and JWT token management.",
      "acceptanceCriteria": [
        "Create auth/utils.py",
        "validate_password_strength(password: str) -> None raises ValueError if password is < 10 chars, lacks a letter, lacks a digit, or lacks a special character (from: !@#$%^&*()_+-=[]{};\\':\"|,.<>/?)",
        "hash_password(password: str) -> str uses passlib bcrypt with rounds=12",
        "verify_password(plain: str, hashed: str) -> bool",
        "create_access_token(user_id: str) -> str: JWT with 15-minute expiry, signed with JWT_SECRET env var",
        "create_refresh_token(user_id: str) -> str: JWT with 7-day expiry (30-day if remember_me=True)",
        "decode_token(token: str) -> dict: raises HTTPException 401 if invalid or expired",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create auth router: register and login endpoints",
      "description": "As a user, I want to create an account or log in so I can access the tool.",
      "acceptanceCriteria": [
        "Create auth/router.py with APIRouter(prefix='/auth')",
        "POST /auth/register: accepts {email, password, confirm_password}; validates password strength; checks for duplicate email (409 if exists); hashes password; inserts user row; returns access token in JSON + sets refresh token as httpOnly SameSite=Strict cookie",
        "POST /auth/login: accepts {email, password, remember_me}; returns generic 'Invalid email or password' for any failure (no user enumeration); on success returns access token + sets refresh cookie",
        "Rate limiter applied to /auth/login: max 10 requests per IP per 15 minutes (use slowapi)",
        "Import and apply Limiter from slowapi in router",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create auth router: logout, token refresh, and get current user",
      "description": "As a logged-in user, I want my session to stay active and to log out securely.",
      "acceptanceCriteria": [
        "Add to auth/router.py:",
        "POST /auth/logout: clears refresh token cookie; returns 200",
        "POST /auth/refresh: reads refresh token from httpOnly cookie; validates it; returns new access token in JSON; returns 401 if cookie missing or invalid",
        "GET /user/me: requires valid Bearer token in Authorization header; returns {id, email, plan, created_at}; returns 401 if missing/invalid",
        "Create get_current_user FastAPI dependency in auth/dependencies.py that extracts and validates Bearer token, returns User object",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create auth router: forgot password and reset password endpoints",
      "description": "As a user who forgot their password, I want to reset it via a secure email link.",
      "acceptanceCriteria": [
        "Add to auth/router.py:",
        "POST /auth/forgot-password: accepts {email}; always returns 200 (never reveals if email exists); if user exists, generate 32-byte cryptographically random token, store hashed token + expiry (1 hour) in users table, call email service to send reset email",
        "POST /auth/reset-password: accepts {token, new_password, confirm_password}; validate token exists and not expired; validate new password strength; update password_hash; clear reset_token fields; return 200",
        "Expired or invalid tokens return 400 with message 'Reset link is invalid or has expired'",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Create Brevo email service",
      "description": "As the system, I need to send transactional emails via Brevo for all key lifecycle events.",
      "acceptanceCriteria": [
        "Create email/service.py",
        "Reads BREVO_API_KEY and FRONTEND_URL from environment",
        "send_welcome_email(to_email: str) -> None: sends HTML email welcoming user, includes link to app",
        "send_password_reset_email(to_email: str, reset_token: str) -> None: sends HTML email with reset link: {FRONTEND_URL}/reset-password?token={reset_token}",
        "send_subscription_confirmation_email(to_email: str, plan: str, renewal_date: str) -> None",
        "send_cancellation_email(to_email: str, access_until: str) -> None",
        "All functions use sib_api_v3_sdk; log errors but do not raise (email failures should not break the main flow)",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Create Stripe checkout session and customer portal endpoints",
      "description": "As a Free user, I want to subscribe to Pro via Stripe Checkout.",
      "acceptanceCriteria": [
        "Create billing/router.py with APIRouter(prefix='/billing')",
        "POST /billing/checkout: requires auth; accepts {interval: 'monthly'|'annual'}; creates or reuses Stripe Customer for user; creates Stripe Checkout Session with correct price ID (STRIPE_PRO_MONTHLY_PRICE_ID or STRIPE_PRO_ANNUAL_PRICE_ID); returns {url: checkout_url}",
        "GET /billing/portal: requires auth; user must have stripe_customer_id; creates Stripe Customer Portal session; returns {url: portal_url}",
        "Reads STRIPE_SECRET_KEY, STRIPE_PRO_MONTHLY_PRICE_ID, STRIPE_PRO_ANNUAL_PRICE_ID, FRONTEND_URL from env",
        "success_url = {FRONTEND_URL}/account?success=true",
        "cancel_url = {FRONTEND_URL}/pricing",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create Stripe webhook handler for subscription lifecycle events",
      "description": "As the system, I need to handle Stripe webhooks to keep subscription status in sync.",
      "acceptanceCriteria": [
        "Add to billing/router.py:",
        "POST /billing/webhook: reads raw request body; verifies Stripe signature using STRIPE_WEBHOOK_SECRET env var; returns 400 if signature invalid",
        "Handle checkout.session.completed: find user by email; upsert subscription row with stripe_customer_id, stripe_subscription_id, status='active', current_period_end; update user.plan='pro'; send subscription confirmation email",
        "Handle customer.subscription.updated: update subscription status and current_period_end",
        "Handle customer.subscription.deleted: update subscription status='canceled'; if current_period_end is past, set user.plan='free'; send cancellation email",
        "Handle invoice.payment_failed: update subscription status='past_due'",
        "All unhandled events return 200 (acknowledged but ignored)",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create plan enforcement dependency for Pro-only and limit-checked routes",
      "description": "As the system, I need server-side plan enforcement so Free users cannot bypass paid limits.",
      "acceptanceCriteria": [
        "Create billing/dependencies.py",
        "require_pro dependency: calls get_current_user; if user.plan != 'pro', raises HTTPException 403 with detail 'This feature requires a Pro subscription. Upgrade at /pricing'",
        "check_bulk_url_limit(url_count: int, user: User) dependency: if user.plan == 'free' and url_count > 10, raises HTTPException 403 with detail 'Free plan supports up to 10 URLs. Upgrade to Pro for up to 500 URLs'",
        "check_ai_usage(user: User, db) dependency: queries ai_usage for current period; if call_count >= 200, raises HTTPException 429 with detail 'Monthly AI limit of 200 calls reached'",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create analysis sessions CRUD router",
      "description": "As a Pro user, I want my analysis sessions saved to the cloud so they persist.",
      "acceptanceCriteria": [
        "Create sessions/router.py with APIRouter(prefix='/sessions')",
        "All endpoints require auth (get_current_user) and Pro plan (require_pro)",
        "GET /sessions: returns list of user's sessions [{id, domain, created_at, updated_at, url_count}] ordered by updated_at DESC",
        "POST /sessions: accepts {domain, config, results}; inserts row; returns created session with id",
        "GET /sessions/{session_id}: returns full session including results; 404 if not found or belongs to different user",
        "DELETE /sessions/{session_id}: deletes session; 404 if not found or belongs to different user; returns 204",
        "PUT /sessions/{session_id}: updates config and/or results; updates updated_at; returns updated session",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Create saved links CRUD router",
      "description": "As a Pro user, I want saved link opportunities persisted to the cloud.",
      "acceptanceCriteria": [
        "Create links/router.py with APIRouter(prefix='/saved-links')",
        "All endpoints require auth + Pro plan",
        "GET /saved-links: returns all user's saved links [{id, link_data, created_at, session_id}] ordered by created_at DESC",
        "POST /saved-links: accepts {link_data: object, session_id: optional UUID}; inserts row; returns created record",
        "DELETE /saved-links/{link_id}: deletes link; 404 if not found or belongs to different user; returns 204",
        "DELETE /saved-links: accepts {ids: list[UUID]} to bulk delete multiple links; returns 204",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create AI suggest router (Gemini proxy with usage tracking)",
      "description": "As a Pro user, I want AI-powered link suggestions without the Gemini API key being exposed in the browser.",
      "acceptanceCriteria": [
        "Create ai/router.py with APIRouter(prefix='/ai')",
        "POST /ai/suggest: requires auth + Pro plan; calls check_ai_usage to enforce 200/month limit",
        "Accepts {source_url, source_content, target_url, target_title, target_keywords} in request body",
        "Calls Google Gemini API using GEMINI_API_KEY env var and GEMINI_MODEL env var (default: gemini-1.5-flash)",
        "Increments ai_usage.call_count for user; creates ai_usage row if first call of period; sets period_start/period_end based on current billing cycle",
        "Returns {suggestion: string, reasoning: string} from Gemini response",
        "Returns remaining_calls in response header X-AI-Calls-Remaining",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Register all new routers in main.py and update CORS + rate limiting",
      "description": "As a developer, I need all new routes wired into the FastAPI app with proper security middleware.",
      "acceptanceCriteria": [
        "Import and include routers from auth, billing, sessions, links, ai in main.py",
        "Add slowapi Limiter to app state and add SlowAPIMiddleware",
        "Update CORS: replace wildcard/Firebase origins with explicit list from ALLOWED_ORIGINS env var (comma-separated); default to localhost:5173 in development",
        "Add /billing/webhook route BEFORE any auth middleware (webhooks use Stripe signature, not JWT)",
        "Apply get_current_user dependency to /bulk-analyze, /analyze, /sitemap routes so they work for both auth'd and anonymous users (return user context without blocking)",
        "Existing endpoints (/health, /config, /sitemap, /analyze, /bulk-analyze) remain functional",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Add React Router and update frontend entry point",
      "description": "As a developer, I need client-side routing so the frontend can have distinct pages for auth, billing, and the main app.",
      "acceptanceCriteria": [
        "Add react-router-dom to frontend/package.json dependencies",
        "Update frontend/src/main.tsx to wrap <App /> with <BrowserRouter>",
        "Create frontend/src/router.tsx defining routes: / (main app), /login, /register, /forgot-password, /reset-password, /pricing, /account",
        "Create ProtectedRoute component that redirects to /login if user is not authenticated",
        "/ route is protected (requires auth)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Create AuthContext for global auth state and token management",
      "description": "As the frontend app, I need a global auth context to store the current user and manage JWT tokens.",
      "acceptanceCriteria": [
        "Create frontend/src/contexts/AuthContext.tsx",
        "AuthContext provides: user (null | {id, email, plan}), accessToken (string | null), login(email, password, rememberMe), logout(), register(email, password), isLoading",
        "Access token stored in React state (memory only, not localStorage)",
        "On app load: call POST /auth/refresh to restore session from httpOnly cookie; set user state if successful",
        "login() calls POST /auth/login, stores access token in state, fetches user profile",
        "logout() calls POST /auth/logout, clears state",
        "register() calls POST /auth/register",
        "Export useAuth() hook for consuming context",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Create Login page",
      "description": "As a returning user, I want a login page to access my account.",
      "acceptanceCriteria": [
        "Create frontend/src/pages/Login.tsx",
        "Form fields: email, password, remember me checkbox",
        "Shows inline error message on failed login",
        "On success: redirects to /",
        "'Forgot password?' link navigates to /forgot-password",
        "'Create account' link navigates to /register",
        "Matches existing app visual style (dark theme, existing CSS variables)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Create Register page",
      "description": "As a new user, I want to create an account with a secure password.",
      "acceptanceCriteria": [
        "Create frontend/src/pages/Register.tsx",
        "Form fields: email, password, confirm password",
        "Real-time password strength indicator showing: length >=10, has letter, has number, has special char",
        "Confirm password mismatch shown inline before submission",
        "On success: redirects to / (user is automatically logged in)",
        "'Already have an account?' link navigates to /login",
        "Matches existing app visual style",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Create ForgotPassword and ResetPassword pages",
      "description": "As a user who forgot their password, I want to reset it via email.",
      "acceptanceCriteria": [
        "Create frontend/src/pages/ForgotPassword.tsx: email input form; on submit calls POST /auth/forgot-password; shows success message 'If that email exists, a reset link has been sent'",
        "Create frontend/src/pages/ResetPassword.tsx: reads token from URL query param; shows new password + confirm password fields with strength indicator; on submit calls POST /auth/reset-password; on success redirects to /login with success toast",
        "Both pages match existing app visual style",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Update api.ts to add auth headers and token refresh interceptor",
      "description": "As the frontend, I need all API calls to include the access token and automatically refresh it when expired.",
      "acceptanceCriteria": [
        "Update frontend/src/services/api.ts",
        "Add createAuthenticatedFetch(accessToken: string | null) helper that injects Authorization: Bearer {token} header on all requests",
        "Add token refresh logic: if a request returns 401, automatically call POST /auth/refresh, update token in AuthContext, then retry the original request once",
        "Export typed API functions for new endpoints: getSessions(), createSession(), deleteSession(), getSavedLinks(), createSavedLink(), deleteSavedLink(), getAiSuggestion(), getMe(), createCheckoutSession(), getBillingPortal()",
        "Existing API functions (fetchSitemap, analyzePage, bulkAnalyze, etc.) updated to accept optional token parameter",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Create Pricing page with Free vs Pro comparison",
      "description": "As a Free user, I want to see what Pro offers and easily upgrade.",
      "acceptanceCriteria": [
        "Create frontend/src/pages/Pricing.tsx",
        "Shows two-column comparison: Free (current) vs Pro ($29/mo or $24/mo annual)",
        "Free column: 10 URLs/scan, no AI suggestions, no saved sessions",
        "Pro column: 500 URLs/scan, AI suggestions (200/month), unlimited saved sessions, checkmark on each feature",
        "Monthly/Annual toggle with '2 months free' label on annual",
        "Upgrade button calls POST /billing/checkout and redirects to returned Stripe URL",
        "If user is already Pro, shows 'Manage Subscription' button linking to billing portal",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Create Account settings page",
      "description": "As a logged-in user, I want to see my account details, plan status, and manage my subscription.",
      "acceptanceCriteria": [
        "Create frontend/src/pages/Account.tsx",
        "Shows: user email, current plan badge (Free / Pro), account creation date",
        "If Pro: shows Stripe renewal date from subscriptions table (via GET /user/me response), 'Manage Billing' button",
        "If Pro: shows AI usage this month (X / 200 calls used) with progress bar",
        "If Free: shows 'Upgrade to Pro' button linking to /pricing",
        "'Log out' button calls logout() from AuthContext then redirects to /login",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Add in-app upgrade prompts when Free users hit plan limits",
      "description": "As the app, I need to show contextual upgrade prompts when Free users try to use gated features.",
      "acceptanceCriteria": [
        "In App.tsx or relevant component: when Free user enters >10 URLs in bulk scan, show banner 'Free plan supports up to 10 URLs. Upgrade to Pro for 500 URLs.' with link to /pricing",
        "When Free user clicks 'Get AI Suggestions', show modal explaining AI is a Pro feature with 'Upgrade' CTA",
        "When Free user tries to save a session, show tooltip/modal explaining sessions require Pro",
        "Saved sessions panel shows lock icon + 'Pro feature' message for Free users",
        "All prompts link to /pricing",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Update sessions and saved links to use backend API for Pro users",
      "description": "As a Pro user, I want my sessions and saved links automatically synced to the cloud instead of localStorage.",
      "acceptanceCriteria": [
        "Update frontend/src/services/storage.ts (or create new cloud-storage.ts): if user.plan === 'pro', save/load sessions via API; if 'free', use localStorage (existing behaviour)",
        "Update SavedSessions.tsx component to load sessions from GET /sessions for Pro users",
        "Update SavedLinksPanel.tsx to load links from GET /saved-links for Pro users",
        "Session save action (after bulk analysis completes) calls POST /sessions for Pro users",
        "Saved links add/remove calls POST /saved-links and DELETE /saved-links/{id} for Pro users",
        "Free users retain existing localStorage behaviour unchanged",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Update Gemini AI integration to use backend proxy endpoint",
      "description": "As the frontend, I need to call the backend /ai/suggest endpoint instead of Gemini directly, so the API key is never exposed.",
      "acceptanceCriteria": [
        "Update frontend/src/services/gemini.ts: replace direct Gemini API calls with POST /ai/suggest via authenticated API client",
        "Remove VITE_GEMINI_API_KEY and VITE_GEMINI_MODEL usage from frontend completely",
        "If user is Free plan and clicks AI suggest, show upgrade prompt (do not call API, handled by US-025)",
        "If API returns 429 (AI limit reached), show user-friendly message 'Monthly AI limit reached. Limit resets on [date]'",
        "Loading state and error handling preserved",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    }
  ]
}
