# Ralph Progress Log
Started: Wed Feb 18 21:17:15 GMT 2026
---

## Codebase Patterns
- Use .venv/bin/python and .venv/bin/pip for all Python operations (not system python)
- The project uses Python 3.14 with a local .venv virtual environment
- Existing deps: fastapi, uvicorn[standard], httpx, beautifulsoup4, trafilatura, lxml, pydantic>=2.5.0

## 2026-02-18 21:30 - US-001
- What was implemented: Added all required Python packages for SaaS backend to requirements.txt
- Files changed: requirements.txt
- **Learnings for future iterations:**
  - Use .venv/bin/pip to install, not system pip
  - All packages installed successfully: passlib[bcrypt], python-jose[cryptography], asyncpg, sqlalchemy[asyncio], alembic, stripe, sib-api-v3-sdk, slowapi, python-multipart, email-validator
  - stripe installed at v14.3.0 (much newer than >=7.0.0 requirement - API may differ from older docs)
  - sib-api-v3-sdk installed at v7.6.0
---

## 2026-02-18 21:35 - US-002
- What was implemented: Created database.py with lazy-initialized async SQLAlchemy engine
- Files changed: database.py (new)
- **Learnings for future iterations:**
  - Engine creation must be deferred (lazy) since DATABASE_URL may be empty at import time
  - Use postgresql+asyncpg:// prefix for async engine; handle postgres:// and postgresql:// URL variants
  - async_session_factory is a callable that returns AsyncSession instances
  - get_db() is an async generator FastAPI dependency that handles commit/rollback/close
---

## 2026-02-18 21:40 - US-003
- What was implemented: Created migrations/001_initial.sql with all 5 tables and RLS policies
- Files changed: migrations/001_initial.sql (new)
- **Learnings for future iterations:**
  - Used app.current_user_id session variable pattern for RLS (set via SET LOCAL app.current_user_id = ... before queries)
  - pgcrypto extension needed for gen_random_uuid()
  - ai_usage has UNIQUE constraint on user_id (one row per user for monthly tracking)
  - All tables use gen_random_uuid() for primary keys
---

## 2026-02-18 21:45 - US-004
- What was implemented: Created db_models.py with SQLAlchemy ORM models for all 5 tables
- Files changed: db_models.py (new)
- **Learnings for future iterations:**
  - Use mapped_column with Mapped[] typed annotations (SQLAlchemy 2.0 style)
  - JSONB from sqlalchemy.dialects.postgresql for JSON columns
  - UUID from sqlalchemy.dialects.postgresql with as_uuid=True for proper Python UUID handling
  - ai_usage has unique constraint on user_id via __table_args__ = (UniqueConstraint(...),)
  - AiUsage relationship is uselist=False (one-to-one with User)
---

## 2026-02-18 21:50 - US-005
- What was implemented: Created auth/utils.py with password hashing and JWT token functions
- Files changed: auth/__init__.py (new), auth/utils.py (new)
- **Learnings for future iterations:**
  - passlib[bcrypt] has compatibility issues with bcrypt 5.x (missing __about__ attribute, changed API)
  - Use `import bcrypt` directly instead of passlib for hashing: bcrypt.gensalt(rounds=12) and bcrypt.hashpw()
  - JWT_SECRET is read at module level but uses os.environ.get() - set before importing if testing
  - decode_token raises HTTPException 401 on any JWTError (expired, invalid signature, etc.)
---
