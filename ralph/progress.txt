# Ralph Progress Log
Started: Wed Feb 18 21:17:15 GMT 2026
---

## Codebase Patterns
- Use .venv/bin/python and .venv/bin/pip for all Python operations (not system python)
- The project uses Python 3.14 with a local .venv virtual environment
- Existing deps: fastapi, uvicorn[standard], httpx, beautifulsoup4, trafilatura, lxml, pydantic>=2.5.0

## 2026-02-18 21:30 - US-001
- What was implemented: Added all required Python packages for SaaS backend to requirements.txt
- Files changed: requirements.txt
- **Learnings for future iterations:**
  - Use .venv/bin/pip to install, not system pip
  - All packages installed successfully: passlib[bcrypt], python-jose[cryptography], asyncpg, sqlalchemy[asyncio], alembic, stripe, sib-api-v3-sdk, slowapi, python-multipart, email-validator
  - stripe installed at v14.3.0 (much newer than >=7.0.0 requirement - API may differ from older docs)
  - sib-api-v3-sdk installed at v7.6.0
---

## 2026-02-18 21:35 - US-002
- What was implemented: Created database.py with lazy-initialized async SQLAlchemy engine
- Files changed: database.py (new)
- **Learnings for future iterations:**
  - Engine creation must be deferred (lazy) since DATABASE_URL may be empty at import time
  - Use postgresql+asyncpg:// prefix for async engine; handle postgres:// and postgresql:// URL variants
  - async_session_factory is a callable that returns AsyncSession instances
  - get_db() is an async generator FastAPI dependency that handles commit/rollback/close
---

## 2026-02-18 21:40 - US-003
- What was implemented: Created migrations/001_initial.sql with all 5 tables and RLS policies
- Files changed: migrations/001_initial.sql (new)
- **Learnings for future iterations:**
  - Used app.current_user_id session variable pattern for RLS (set via SET LOCAL app.current_user_id = ... before queries)
  - pgcrypto extension needed for gen_random_uuid()
  - ai_usage has UNIQUE constraint on user_id (one row per user for monthly tracking)
  - All tables use gen_random_uuid() for primary keys
---

## 2026-02-18 21:45 - US-004
- What was implemented: Created db_models.py with SQLAlchemy ORM models for all 5 tables
- Files changed: db_models.py (new)
- **Learnings for future iterations:**
  - Use mapped_column with Mapped[] typed annotations (SQLAlchemy 2.0 style)
  - JSONB from sqlalchemy.dialects.postgresql for JSON columns
  - UUID from sqlalchemy.dialects.postgresql with as_uuid=True for proper Python UUID handling
  - ai_usage has unique constraint on user_id via __table_args__ = (UniqueConstraint(...),)
  - AiUsage relationship is uselist=False (one-to-one with User)
---

## 2026-02-18 21:50 - US-005
- What was implemented: Created auth/utils.py with password hashing and JWT token functions
- Files changed: auth/__init__.py (new), auth/utils.py (new)
- **Learnings for future iterations:**
  - passlib[bcrypt] has compatibility issues with bcrypt 5.x (missing __about__ attribute, changed API)
  - Use `import bcrypt` directly instead of passlib for hashing: bcrypt.gensalt(rounds=12) and bcrypt.hashpw()
  - JWT_SECRET is read at module level but uses os.environ.get() - set before importing if testing
  - decode_token raises HTTPException 401 on any JWTError (expired, invalid signature, etc.)
---

## 2026-02-18 21:55 - US-006, US-007, US-008
- What was implemented: auth/router.py with all auth endpoints + auth/dependencies.py
- Files changed: auth/router.py (new), auth/dependencies.py (new)
- **Learnings for future iterations:**
  - GET /user/me uses lambda dependency placeholder in auth/router.py; overridden in main.py with app.dependency_overrides
  - httpOnly refresh cookie uses path="/auth/refresh" to scope it to only that endpoint
  - forgot-password stores SHA-256 hash of reset token (not plaintext) in DB
  - send_password_reset_email imported as `from email_service import ...` (not `email.service` - avoid stdlib email module collision)
  - Rate limiting for /auth/login applied in main.py (not in the router)
---

## 2026-02-18 22:00 - US-009
- What was implemented: email_service.py with Brevo transactional email functions
- Files changed: email_service.py (new)
- **Learnings for future iterations:**
  - Created email_service.py (not email/service.py) to avoid collision with Python stdlib `email` module
  - auth/router.py already imports from email_service correctly
  - sib_api_v3_sdk uses Configuration() with api_key["api-key"] pattern
  - All email functions are synchronous (sib_api_v3_sdk is not async)
---

## 2026-02-18 22:05 - US-010, US-011, US-012
- What was implemented: billing/router.py (checkout, portal, webhook), billing/dependencies.py
- Files changed: billing/__init__.py, billing/router.py, billing/dependencies.py (all new)
- **Learnings for future iterations:**
  - stripe 14.x uses stripe.checkout.Session.create(), stripe.billing_portal.Session.create()
  - stripe 14.x: stripe.error.SignatureVerificationError for invalid webhooks
  - stripe.Webhook.construct_event() validates signature
  - User is found by metadata user_id in checkout.session.completed (more reliable than email)
  - check_bulk_url_limit is a sync function (not async), not a FastAPI dependency
---

## 2026-02-18 22:10 - US-013, US-014, US-015
- What was implemented: sessions/router.py, links/router.py, ai_router/router.py
- Files changed: sessions/, links/, ai_router/ directories (all new)
- **Learnings for future iterations:**
  - Used ai_router/ directory (not ai/) to avoid conflicts with built-in Python names
  - google-generativeai is deprecated; use google-genai with `from google import genai`
  - genai.Client(api_key=...).models.generate_content() is the modern API
  - AI usage resets monthly based on period_end check
  - Bulk delete uses SQLAlchemy delete() with .in_() for efficient batch operations
---

## 2026-02-18 22:15 - US-016
- What was implemented: Updated main.py with all new routers, SlowAPI middleware, CORS from env var
- Files changed: main.py, auth/router.py (fixed /user/me dependency)
- **Learnings for future iterations:**
  - Import get_current_user directly in auth/router.py - no circular import
  - slowapi: app.state.limiter = limiter; app.add_exception_handler(RateLimitExceeded, ...)
  - ALLOWED_ORIGINS env var: comma-separated list of origins
  - billing/webhook is included normally since Stripe signature verification is in the endpoint itself
  - Rate limit for /auth/login goes in the route decorator: @limiter.limit("10/15minutes")
  - The _noop middleware was unnecessary, removed it
---
